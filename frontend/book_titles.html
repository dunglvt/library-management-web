<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qu·∫£n l√Ω ƒë·∫ßu s√°ch</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* CSS c≈© gi·ªØ nguy√™n */
    .hint-box {
      background: #f0f9ff;
      padding: 12px;
      border-radius: 8px;
      border: 1px dashed #bae6fd;
      font-size: 0.9rem;
      color: #0369a1;
      margin-top: 8px;
      margin-bottom: 15px;
    }

    .preview-text {
      margin-top: 10px;
      font-weight: bold;
      color: #0284c7;
      font-size: 1.1rem;
      border-top: 1px solid #bae6fd;
      padding-top: 8px;
    }

    .code-input-group {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .code-part {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      font-weight: 600;
      color: #334155;
    }

    .code-part:focus {
      border-color: #0d9488;
      outline: none;
    }

    /* CSS M·ªöI: N√∫t g·ª£i √Ω */
    .btn-suggest {
      background: #e0f2fe;
      color: #0284c7;
      border: 1px solid #bae6fd;
      padding: 0 10px;
      height: 42px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }

    .btn-suggest:hover {
      background: #bae6fd;
      color: #0369a1;
    }

    .btn-suggest i {
      font-size: 1.1rem;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body>
  <nav id="nav"></nav>

  <div class="container">
    <div class="card">
      <h1>Qu·∫£n l√Ω ƒë·∫ßu s√°ch</h1>

      <div class="row">
        <div class="col">
          <h3>Th√™m / S·ª≠a ƒë·∫ßu s√°ch</h3>
          <input type="hidden" id="id" />

          <label>M√£ ƒë·∫ßu s√°ch <span style="color:red">*</span></label>

          <div class="code-input-group">
            <select id="part_cat" class="code-part" style="width: 160px;">
              <option value="GT">GT (Gi√°o tr√¨nh)</option>
              <option value="VH">VH (VƒÉn h·ªçc)</option>
              <option value="KT">KT (Kinh t·∫ø)</option>
              <option value="TK">TK (Tham kh·∫£o)</option>
              <option value="LUAN">LUAN (Lu·∫≠n vƒÉn)</option>
              <option value="KHAC">KHAC (Kh√°c)</option>
            </select>

            <span>-</span>

            <input id="part_source" class="code-part" placeholder="PTIT"
              style="width: 80px; text-transform: uppercase;" />

            <span>-</span>

            <input id="part_num" type="number" class="code-part" placeholder="001" style="flex: 1;" />

            <button type="button" class="btn-suggest" id="btnAutoNum" title="L·∫•y s·ªë ti·∫øp theo">
              <i class="fas fa-magic"></i> Auto
            </button>
          </div>

          <input type="hidden" id="code" />

          <div class="hint-box">
            <div class="preview-text">
              üëâ M√£ s·∫Ω t·∫°o: <span id="preview_code" style="color:#e11d48">GT-???-???</span>
            </div>
            <div style="font-size:0.8rem; color:#64748b; margin-top:4px;">
              <i>H∆∞·ªõng d·∫´n: Nh·∫≠p ngu·ªìn (VD: PTIT) r·ªìi b·∫•m n√∫t <b>Auto</b> ƒë·ªÉ l·∫•y s·ªë ti·∫øp theo.</i>
            </div>
          </div>

          <label>T√™n s√°ch</label>
          <input id="title" placeholder="VD: Nh·∫≠p m√¥n C√¥ng ngh·ªá ph·∫ßn m·ªÅm" />
          <label>T√°c gi·∫£</label>
          <input id="author" placeholder="VD: Ng√¥ C√¥ng Th·∫Øng" />
          <label>NƒÉm XB</label>
          <input id="publish_year" type="number" placeholder="VD: 2022" />
          <label>Gi√° b√¨a</label>
          <input id="cover_price" type="number" value="0" />
          <label>Nh√† xu·∫•t b·∫£n</label>
          <select id="publisher_id"></select>
          <label>M√¥ t·∫£</label>
          <textarea id="description" rows="4"></textarea>

          <div style="display:flex; gap:10px; margin-top:12px;">
            <button class="primary" id="btnSave">L∆∞u</button>
            <button id="btnClear">X√≥a form</button>
          </div>
          <div id="msg"></div>
        </div>

        <div class="col">
          <h3>Danh s√°ch & T√¨m ki·∫øm</h3>
          <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input id="q" placeholder="Nh·∫≠p t√™n, m√£..." autocomplete="off" />
            <button id="btnSearch">T√¨m</button>
          </div>
          <div id="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="api.js"></script>
  <script>
    const user = requireLogin();
    renderNav("nav");
    const msg = document.getElementById("msg");
    const show = (t, ok = false) => msg.innerHTML = `<div class="msg ${ok ? 'ok' : 'err'}">${t}</div>`;

    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u danh s√°ch s√°ch (d√πng ƒë·ªÉ t√≠nh s·ªë ti·∫øp theo)
    let globalBooks = [];

    // --- 1. LOGIC T√çNH S·ªê TI·∫æP THEO (AUTO-INCREMENT) ---
    function getNextNumber(cat, source) {
      if (!source) return 1;

      // T√¨m prefix v√≠ d·ª•: "GT-PTIT-"
      const prefix = `${cat}-${source.toUpperCase()}-`;

      let maxNum = 0;

      // Duy·ªát qua to√†n b·ªô s√°ch hi·ªán c√≥ ƒë·ªÉ t√¨m s·ªë l·ªõn nh·∫•t c·ªßa d√≤ng n√†y
      globalBooks.forEach(book => {
        if (book.code && book.code.startsWith(prefix)) {
          // T√°ch ph·∫ßn s·ªë cu·ªëi c√πng ra (GT-PTIT-005 -> l·∫•y 005)
          const parts = book.code.split('-');
          const numPart = parseInt(parts[parts.length - 1]);
          if (!isNaN(numPart) && numPart > maxNum) {
            maxNum = numPart;
          }
        }
      });

      return maxNum + 1;
    }

    document.getElementById("btnAutoNum").addEventListener("click", () => {
      const cat = document.getElementById("part_cat").value;
      const source = document.getElementById("part_source").value.trim();

      if (!source) {
        alert("Vui l√≤ng nh·∫≠p M√£ ngu·ªìn (VD: PTIT) tr∆∞·ªõc khi b·∫•m Auto!");
        document.getElementById("part_source").focus();
        return;
      }

      // G·ªçi h√†m t√≠nh s·ªë
      const nextNum = getNextNumber(cat, source);

      // ƒêi·ªÅn v√†o √¥ input v√† c·∫≠p nh·∫≠t preview
      document.getElementById("part_num").value = nextNum;
      generateCode(); // C·∫≠p nh·∫≠t l·∫°i m√£ full

      // Hi·ªáu ·ª©ng nh√°y nh·∫π ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt ƒë√£ ƒëi·ªÅn
      const inputNum = document.getElementById("part_num");
      inputNum.style.backgroundColor = "#dcfce7"; // Xanh nh·∫°t
      setTimeout(() => inputNum.style.backgroundColor = "#fff", 500);
    });

    // --- 2. LOGIC GH√âP M√É ---
    const partCat = document.getElementById("part_cat");
    const partSource = document.getElementById("part_source");
    const partNum = document.getElementById("part_num");
    const finalCodeEl = document.getElementById("code");
    const previewEl = document.getElementById("preview_code");

    function generateCode() {
      const cat = partCat.value;
      const source = partSource.value.toUpperCase().trim() || "???";
      let num = "???";
      if (partNum.value) {
        num = partNum.value.toString().padStart(3, '0');
      }
      const fullCode = `${cat}-${source}-${num}`;

      if (source !== "???" && num !== "???") finalCodeEl.value = fullCode;
      else finalCodeEl.value = "";

      previewEl.innerText = fullCode;
    }

    partCat.addEventListener("change", generateCode);
    partSource.addEventListener("input", generateCode);
    partNum.addEventListener("input", generateCode);

    // --- 3. C√ÅC H√ÄM CRUD C∆† B·∫¢N (Gi·ªØ nguy√™n logic c≈©) ---
    function getPayload() {
      return {
        code: document.getElementById("code").value.trim(),
        title: document.getElementById("title").value.trim(),
        author: document.getElementById("author").value.trim(),
        publish_year: Number(document.getElementById("publish_year").value),
        cover_price: Number(document.getElementById("cover_price").value),
        publisher_id: Number(document.getElementById("publisher_id").value),
        description: document.getElementById("description").value.trim(),
      };
    }

    function fillForm(r) {
      document.getElementById("id").value = r.id;
      if (r.code && r.code.includes("-")) {
        const parts = r.code.split("-");
        if (parts.length >= 3) {
          document.getElementById("part_cat").value = parts[0];
          document.getElementById("part_source").value = parts[1];
          document.getElementById("part_num").value = parseInt(parts[2]);
        }
        else if (parts.length === 2) {
          document.getElementById("part_cat").value = parts[0];
          document.getElementById("part_source").value = "";
          document.getElementById("part_num").value = parseInt(parts[1]);
        }
        generateCode();
      } else {
        document.getElementById("part_cat").value = "GT";
        document.getElementById("part_source").value = r.code;
        document.getElementById("part_num").value = "";
        generateCode();
      }
      document.getElementById("title").value = r.title;
      document.getElementById("author").value = r.author;
      document.getElementById("publish_year").value = r.publish_year || "";
      document.getElementById("cover_price").value = r.cover_price;
      document.getElementById("publisher_id").value = r.publisher_id || "";
      document.getElementById("description").value = r.description || "";
    }

    function clearForm() {
      document.getElementById("id").value = "";
      document.getElementById("part_cat").value = "GT";
      document.getElementById("part_source").value = "";
      document.getElementById("part_num").value = "";
      generateCode();
      document.getElementById("title").value = "";
      document.getElementById("author").value = "";
      document.getElementById("publish_year").value = "";
      document.getElementById("cover_price").value = 0;
      document.getElementById("description").value = "";
      msg.innerHTML = "";
    }

    async function loadPublishers() {
      try {
        const res = await apiFetch("/publishers");
        const rows = res.data || [];
        document.getElementById("publisher_id").innerHTML = rows.map(p => `<option value="${p.id}">${p.name}</option>`).join("");
      } catch (e) { console.error(e); }
    }

    async function load() {
      try {
        const q = document.getElementById("q").value.trim();
        // G·ªçi API l·∫•y danh s√°ch
        const res = await apiFetch(`/books/titles?q=${encodeURIComponent(q)}`);
        const rows = res.data || [];

        // L∆ØU L·∫†I V√ÄO BI·∫æN TO√ÄN C·ª§C ƒê·ªÇ D√ôNG T√çNH S·ªê AUTO
        globalBooks = rows;

        document.getElementById("list").innerHTML = `
        <table>
          <thead><tr><th>M√£</th><th>T√™n</th><th>T√°c gi·∫£</th><th>NXB</th><th></th></tr></thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td><b>${r.code}</b></td>
                <td>${r.title}</td>
                <td>${r.author}</td>
                <td>${r.publisher_name || '-'}</td>
                <td><button class="btnEdit" data-id="${r.id}">S·ª≠a</button></td>
              </tr>`).join("")}
          </tbody>
        </table>`;

        const allRows = rows;
        document.querySelectorAll(".btnEdit").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            const r = allRows.find(x => String(x.id) === String(id));
            fillForm(r);
            show("ƒê√£ n·∫°p d·ªØ li·ªáu. H√£y s·ª≠a v√† b·∫•m L∆∞u.", true);
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
        });
      } catch (e) { show(e.message); }
    }

    document.getElementById("btnSearch").addEventListener("click", load);
    document.getElementById("btnClear").addEventListener("click", clearForm);

    // --- C·∫¨P NH·∫¨T LOGIC L∆ØU (X·ª¨ L√ù L·ªñI TR√ôNG L·∫∂P) ---
    document.getElementById("btnSave").addEventListener("click", async () => {
      // 1. Reset tr·∫°ng th√°i c≈©
      show("ƒêang x·ª≠ l√Ω...", true);
      document.getElementById("part_num").style.border = "1px solid #cbd5e1"; // Reset vi·ªÅn
      document.getElementById("part_num").style.backgroundColor = "#fff";     // Reset n·ªÅn

      try {
        const id = document.getElementById("id").value.trim();
        const payload = getPayload();

        // Validate c∆° b·∫£n
        if (!payload.code || payload.code.includes("???")) {
          // B√¥i ƒë·ªè √¥ s·ªë n·∫øu ch∆∞a nh·∫≠p
          document.getElementById("part_num").style.border = "1px solid red";
          document.getElementById("part_num").focus();
          throw new Error("M√£ s√°ch ch∆∞a h·ª£p l·ªá! Vui l√≤ng nh·∫≠p ƒë·ªß Ngu·ªìn v√† S·ªë.");
        }
        if (!payload.title) {
          document.getElementById("title").focus();
          throw new Error("Thi·∫øu t√™n s√°ch! Vui l√≤ng nh·∫≠p t√™n s√°ch.");
        }

        // G·ª≠i API
        if (id) {
          await apiFetch(`/books/titles/${id}`, { method: "PUT", body: JSON.stringify(payload) });
          show("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!", true);
        } else {
          await apiFetch("/books/titles", { method: "POST", body: JSON.stringify(payload) });
          show("‚úÖ Th√™m m·ªõi th√†nh c√¥ng!", true);
        }

        // Th√†nh c√¥ng th√¨ x√≥a form v√† load l·∫°i
        clearForm();
        load();

        // C·∫≠p nh·∫≠t l·∫°i danh s√°ch global ƒë·ªÉ n√∫t Auto t√≠nh ƒë√∫ng cho l·∫ßn sau
        const res = await apiFetch(`/books/titles`);
        if (res.data) globalBooks = res.data;

      } catch (e) {
        // --- X·ª¨ L√ù L·ªñI TH√îNG MINH T·∫†I ƒê√ÇY ---

        // N·∫øu Server tr·∫£ v·ªÅ l·ªói "Duplicate entry" (Tr√πng kh√≥a ch√≠nh)
        if (e.message && e.message.includes("Duplicate entry")) {
          const duplicateCode = document.getElementById("code").value;

          // 1. Hi·ªán th√¥ng b√°o ti·∫øng Vi·ªát d·ªÖ hi·ªÉu
          show(`‚ö†Ô∏è M√£ s√°ch <b>${duplicateCode}</b> ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!<br>üëâ Vui l√≤ng nh·∫≠p s·ªë kh√°c ho·∫∑c b·∫•m n√∫t <b>Auto</b>.`, false);

          // 2. B√¥i ƒë·ªè √¥ nh·∫≠p s·ªë ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt sai ·ªü ƒë√¢u
          const numInput = document.getElementById("part_num");
          numInput.style.border = "2px solid #ef4444"; // Vi·ªÅn ƒë·ªè ƒë·∫≠m
          numInput.style.backgroundColor = "#fee2e2";   // N·ªÅn ƒë·ªè nh·∫°t
          numInput.focus(); // ƒê∆∞a con tr·ªè chu·ªôt v√†o ƒë√≥ lu√¥n
        }
        else {
          // C√°c l·ªói kh√°c th√¨ hi·ªán nguy√™n vƒÉn
          show("‚ùå L·ªói: " + e.message, false);
        }
      }
    });

    (async () => {
      await loadPublishers();
      await load();
      generateCode();
    })();
  </script>
</body>

</html>
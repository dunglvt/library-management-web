<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qu·∫£n l√Ω Nh√† xu·∫•t b·∫£n</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .filter-box {
      background: #f8fafc;
      padding: 24px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.95rem;
    }

    th {
      background: #f1f5f9;
      color: #475569;
      font-weight: 700;
      padding: 12px 16px;
      border-bottom: 2px solid #e2e8f0;
      text-align: left;
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid #e2e8f0;
      color: #334155;
      vertical-align: middle;
    }

    tr:hover td {
      background: #f8fafc;
    }

    .msg {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
    }

    .msg.ok {
      background: #ecfdf5;
      color: #047857;
      border: 1px solid #a7f3d0;
    }

    .msg.err {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    /* Style cho n√∫t X√≥a */
    .btnDelete {
      cursor: pointer;
      color: #ef4444;
      /* M√†u ƒë·ªè */
      background: none;
      border: none;
      font-weight: 600;
      margin-left: 10px;
    }

    .btnDelete:hover {
      text-decoration: underline;
    }

    .btnEdit {
      cursor: pointer;
      color: #0d9488;
      /* M√†u xanh */
      background: none;
      border: none;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <nav id="nav"></nav>

  <div class="container">
    <div class="card">
      <h1>Qu·∫£n l√Ω Nh√† xu·∫•t b·∫£n</h1>

      <div class="row">
        <div class="col" style="flex: 0 0 320px;">
          <div class="filter-box">
            <h3 style="margin-top:0; color:#334155;">üõ†Ô∏è Th√™m / S·ª≠a</h3>
            <input type="hidden" id="id" />
            <label>T√™n nh√† xu·∫•t b·∫£n <span style="color:red">*</span></label>
            <input id="name" placeholder="VD: NXB Kim ƒê·ªìng" autocomplete="off" />
            <div style="display:flex; gap:10px; margin-top:20px;">
              <button class="primary" id="btnSave" style="flex:1">L∆∞u</button>
              <button id="btnClear" style="flex:1; background:#fff; border:1px solid #cbd5e1">X√≥a form</button>
            </div>
            <div id="msg"></div>
          </div>
        </div>

        <div class="col" style="flex: 1;">
          <h3 style="margin-top:0;">üìã Danh s√°ch Nh√† xu·∫•t b·∫£n</h3>
          <div style="display:flex; gap:5px; margin-bottom:15px;">
            <input id="q" placeholder="Nh·∫≠p t√™n NXB ƒë·ªÉ t√¨m..." style="max-width: 300px;" autocomplete="off" />
            <button id="btnSearch">T√¨m ki·∫øm</button>
          </div>
          <div id="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="api.js"></script>
  <script>
    const user = requireLogin();
    renderNav("nav");

    const msg = document.getElementById("msg");
    const show = (t, ok = false) => msg.innerHTML = `<div class="msg ${ok ? 'ok' : 'err'}">${t}</div>`;
    let currentData = [];

    function normalizeName(str) {
      if (!str) return "";
      return str.toLowerCase().replace(/^(nxb|nh√† xu·∫•t b·∫£n)\s+/g, '').replace(/\s+/g, ' ').trim();
    }

    function clearForm() {
      document.getElementById("id").value = "";
      document.getElementById("name").value = "";
      msg.innerHTML = "";
    }
    document.getElementById("btnClear").addEventListener("click", clearForm);

    async function load() {
      try {
        const q = document.getElementById("q").value.trim();
        const data = await apiFetch("/publishers" + (q ? `?q=${encodeURIComponent(q)}` : ""));
        currentData = data.data || [];

        document.getElementById("list").innerHTML = `
        <table>
          <thead>
            <tr>
                <th style="width: 60px;">STT</th>
                <th>T√™n Nh√† xu·∫•t b·∫£n</th>
                <th style="width: 120px; text-align:right;">Thao t√°c</th>
            </tr>
          </thead>
          <tbody>
            ${currentData.map((r, index) => `
              <tr>
                <td style="color:#64748b; font-weight:bold;">${index + 1}</td>
                <td><b>${r.name}</b></td>
                <td style="text-align:right;">
                    <button class="btnEdit" data-id="${r.id}" data-name="${r.name}">S·ª≠a</button>
                    <button class="btnDelete" data-id="${r.id}" data-name="${r.name}">X√≥a</button>
                </td>
              </tr>`).join("")}
          </tbody>
        </table>`;

        // S·ª± ki·ªán S·ª≠a
        document.querySelectorAll(".btnEdit").forEach(btn => {
          btn.addEventListener("click", () => {
            document.getElementById("id").value = btn.getAttribute("data-id");
            document.getElementById("name").value = btn.getAttribute("data-name");
            show("ƒê√£ n·∫°p d·ªØ li·ªáu. H√£y s·ª≠a v√† b·∫•m L∆∞u.", true);
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
        });

        // --- S·ª∞ KI·ªÜN X√ìA ---
        document.querySelectorAll(".btnDelete").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            const name = btn.getAttribute("data-name");

            if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a Nh√† xu·∫•t b·∫£n "${name}" kh√¥ng?`)) {
              try {
                show("ƒêang x√≥a...", true);
                await apiFetch(`/publishers/${id}`, { method: "DELETE" });
                show(`‚úÖ ƒê√£ x√≥a th√†nh c√¥ng: ${name}`, true);
                load(); // T·∫£i l·∫°i danh s√°ch
                if (document.getElementById("id").value === id) clearForm(); // N·∫øu ƒëang s·ª≠a ch√≠nh n√≥ th√¨ x√≥a form
              } catch (e) {
                // L·ªói th∆∞·ªùng g·∫∑p: Nh√† xu·∫•t b·∫£n ƒëang c√≥ s√°ch li√™n k·∫øt
                if (e.message.includes("foreign key")) {
                  show("‚ùå Kh√¥ng th·ªÉ x√≥a! Nh√† xu·∫•t b·∫£n n√†y ƒëang c√≥ ƒë·∫ßu s√°ch li√™n k·∫øt trong h·ªá th·ªëng.", false);
                } else {
                  show("‚ùå L·ªói: " + e.message, false);
                }
              }
            }
          });
        });

      } catch (e) { show(e.message); }
    }

    document.getElementById("btnSearch").addEventListener("click", load);

    document.getElementById("btnSave").addEventListener("click", async () => {
      show("ƒêang x·ª≠ l√Ω...", true);
      try {
        const id = document.getElementById("id").value.trim();
        const name = document.getElementById("name").value.trim();
        if (!name) throw new Error("Vui l√≤ng nh·∫≠p t√™n Nh√† xu·∫•t b·∫£n!");

        const inputNormalized = normalizeName(name);
        const duplicate = currentData.find(p => {
          if (id && String(p.id) === String(id)) return false;
          return normalizeName(p.name) === inputNormalized;
        });
        if (duplicate) throw new Error(`‚ö†Ô∏è T√™n n√†y ƒë√£ t·ªìn t·∫°i d∆∞·ªõi d·∫°ng: "${duplicate.name}"`);

        if (id) {
          await apiFetch(`/publishers/${id}`, { method: "PUT", body: JSON.stringify({ name }) });
          show("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!", true);
        } else {
          await apiFetch("/publishers", { method: "POST", body: JSON.stringify({ name }) });
          show("‚úÖ Th√™m m·ªõi th√†nh c√¥ng!", true);
        }
        clearForm();
        await load();
      } catch (e) { show(e.message); }
    });

    load();
  </script>
</body>

</html>
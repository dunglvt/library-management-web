<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Th·ªëng k√™ doanh thu ti·ªÅn ph·∫°t</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* CSS Giao di·ªán B√°o c√°o Chuy√™n nghi·ªáp */
        .filter-box {
            background: #f8fafc;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.95rem;
        }

        th {
            background: #f1f5f9;
            color: #475569;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            padding: 12px 16px;
            border-bottom: 2px solid #e2e8f0;
            text-align: left;
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
            vertical-align: middle;
        }

        tr:hover td {
            background: #f8fafc;
        }

        .summary-bar {
            background: #ecfdf5;
            color: #047857;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #a7f3d0;
            margin-bottom: 20px;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <nav id="nav"></nav>

    <div class="container">
        <div class="card">
            <h1>Doanh thu ti·ªÅn ph·∫°t</h1>

            <div class="row">
                <div class="col" style="flex: 0 0 300px;">
                    <div class="filter-box">
                        <h3 style="margin-top:0; color:#334155; font-size:1.1rem;">Ch·ªçn kho·∫£ng th·ªùi gian</h3>

                        <label>T·ª´ ng√†y</label>
                        <input id="from" type="date" />

                        <label>ƒê·∫øn ng√†y</label>
                        <input id="to" type="date" />

                        <button style="margin-top:24px; width: 100%;" class="primary" id="btnRun">Xem b√°o c√°o</button>

                        <div class="small" style="margin-top:15px; color: #64748b; font-style: italic;">L∆∞u √Ω: Nh·∫≠p ƒë√∫ng
                            ƒë·ªãnh d·∫°ng ng√†y.</div>
                        <div id="msg"></div>
                    </div>
                </div>

                <div class="col" style="flex: 1;">
                    <h3 style="margin-top:0;">üìã Chi ti·∫øt c√°c kho·∫£n thu</h3>

                    <div id="summaryBox" style="margin-bottom: 20px;">
                        <div
                            style="padding:40px; text-align:center; color:#94a3b8; background:#f8fafc; border-radius:12px; border:1px dashed #cbd5e1;">
                            Vui l√≤ng ch·ªçn ng√†y ƒë·ªÉ xem doanh thu.
                        </div>
                    </div>

                    <div id="out"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script>
        // --- GI·ªÆ NGUY√äN 100% LOGIC C≈® ---
        const user = requireLogin();
        // B·∫£o v·ªá: Ch·ªâ Manager m·ªõi ƒë∆∞·ª£c v√†o
        if (user.role !== 'MANAGER') {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p');
            location.href = 'dashboard.html';
        }
        renderNav("nav");

        const msg = document.getElementById("msg");
        const show = (t, ok = false) => msg.innerHTML = `<div class="msg ${ok ? 'ok' : 'err'}">${t}</div>`;

        // Format ti·ªÅn t·ªá VNƒê
        const fmtMoney = (n) => Number(n).toLocaleString('vi-VN') + ' ƒë';

        document.getElementById("btnRun").addEventListener("click", async () => {
            msg.innerHTML = "";
            try {
                const from = document.getElementById("from").value;
                const to = document.getElementById("to").value;
                if (!from || !to) throw new Error("Vui l√≤ng ch·ªçn ƒë·ªß th·ªùi gian b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c!");

                const res = await apiFetch(`/stats/revenue?from=${from}&to=${to}`);
                const sum = res.summary;
                const rows = res.details || [];

                // 1. Hi·ªÉn th·ªã t·ªïng quan (HTML m·ªõi cho ƒë·∫πp h∆°n nh∆∞ng n·ªôi dung v·∫´n v·∫≠y)
                document.getElementById("summaryBox").innerHTML = `
                    <div class="summary-bar" style="display:block;">
                        <div style="font-size:1.1rem; margin-bottom:5px; display:flex; justify-content:space-between;">
                            <span>T·ªïng doanh thu:</span>
                            <b style="font-size:1.3rem;">${fmtMoney(sum.total_revenue || 0)}</b>
                        </div>
                        <div style="font-size:0.9em; color:#065f46; margin-top:10px; border-top:1px solid #a7f3d0; padding-top:10px;">
                            ‚Ä¢ Ph·∫°t tr·ªÖ h·∫°n: <b>${fmtMoney(sum.total_late || 0)}</b> <br/>
                            ‚Ä¢ Ph·∫°t h·ªèng/m·∫•t: <b>${fmtMoney(sum.total_damage || 0)}</b>
                        </div>
                    </div>
                `;

                // 2. Hi·ªÉn th·ªã b·∫£ng chi ti·∫øt
                if (rows.length === 0) {
                    document.getElementById("out").innerHTML = "<div class='msg err' style='margin-top:0'>Kh√¥ng c√≥ kho·∫£n ph·∫°t n√†o trong th·ªùi gian n√†y.</div>";
                    return;
                }

                document.getElementById("out").innerHTML = `
                <table>
                  <thead><tr><th>Ng√†y</th><th>ƒê·ªôc gi·∫£</th><th>M√£ quy·ªÉn s√°ch</th><th>L√Ω do</th><th style="text-align:right">S·ªë ti·ªÅn</th></tr></thead>
                  <tbody>
                    ${rows.map(r => {
                    // Logic hi·ªÉn th·ªã l√Ω do ph·∫°t (Gi·ªØ nguy√™n)
                    let reason = [];
                    if (r.late_fee > 0) reason.push(`Tr·ªÖ (${fmtMoney(r.late_fee)})`);
                    if (r.damage_fee > 0) reason.push(`H·ªèng (${fmtMoney(r.damage_fee)})`);
                    return `
                      <tr>
                        <td>${new Date(r.return_date).toLocaleDateString('vi-VN')}</td>
                        <td><b>${r.reader_name}</b><br/><span style="font-size:0.85rem; color:#64748b">${r.reader_code}</span></td>
                        <td>${r.book_barcode}</td>
                        <td>${reason.join(', ')}</td>
                        <td style="text-align:right; font-weight:bold; color:#0f172a;">${fmtMoney(r.total_fee)}</td>
                      </tr>`;
                }).join("")}
                  </tbody>
                </table>`;

            } catch (e) {
                show(e.message);
            }
        });
    </script>
</body>

</html>